# UI推理工具 - 使用说明文档

## 目录
1. [项目介绍](#项目介绍)
2. [环境要求](#环境要求)
3. [文件结构](#文件结构)
4. [快速开始](#快速开始)
5. [使用方法](#使用方法)
6. [参数说明](#参数说明)
7. [使用示例](#使用示例)
8. [输出说明](#输出说明)
9. [常见问题](#常见问题)
10. [故障排除](#故障排除)

---

## 项目介绍

本工具是一个基于深度学习的UI界面分割工具，可以将UI设计图片自动分割成不同的组件，并生成对应的HTML和CSS代码。

**主要功能：**
- 对UI图片进行语义分割
- 识别UI组件（按钮、文本框、列表等）
- 生成对应的HTML和CSS代码
- 支持CPU和GPU推理

---

## 环境要求

### 使用可执行文件（推荐）

**无需安装任何环境！** 可执行文件已经包含了所有必需的依赖，可以直接运行。

**系统要求：**
- Windows 10/11 (64位)
- 至少 4GB 可用内存
- 至少 2GB 可用磁盘空间（用于可执行文件和输出文件）

### 使用源代码

如果需要从源代码运行，需要以下环境：

- Python 3.7+
- PyTorch 1.0+
- 其他依赖（见 `requirements.txt`）

---

## 文件结构

```
torchcv-master/
├── dist/
│   └── ui_inference_dist/
│       └── ui_inference.exe          # 可执行文件（单文件，包含所有依赖）
├── scripts/
│   ├── build_exe_clean.ps1          # 打包脚本
│   ├── test_exe.bat                 # 测试脚本
│   └── pyinstaller_ui_inference.spec # PyInstaller配置文件
├── configs/
│   └── seg/
│       └── sfnet_res101_ui.conf     # 模型配置文件
├── checkpoints/
│   └── seg/
│       └── ui/
│           └── sfnet_res101_ui_latest.pth  # 模型权重文件
├── testimage/                        # 测试图片目录
│   └── *.png                        # 测试图片
├── ui_inference_main.py             # 源代码主文件
└── 使用说明.md                      # 本文档
```

---

## 快速开始

### 方式一：使用可执行文件（推荐）

1. **准备文件**
   - 确保 `ui_inference.exe` 在 `dist/ui_inference_dist/` 目录中
   - 准备一张UI图片（PNG格式）
   - 确保模型权重文件 `sfnet_res101_ui_latest.pth` 在 `checkpoints/seg/ui/` 目录中

2. **运行测试脚本**
   ```batch
   .\scripts\test_exe.bat
   ```
   这将自动查找 `testimage` 目录下的PNG图片并运行推理。

3. **查看结果**
   - 输出文件在 `dist/ui_inference_dist/test_output/` 目录
   - 打开 `output.html` 查看生成的HTML代码

### 方式二：手动运行可执行文件

```batch
cd dist\ui_inference_dist
ui_inference.exe --image "path\to\your\image.png" --config configs\seg\sfnet_res101_ui.conf --checkpoint "path\to\checkpoint.pth" --output "output_dir" --gpu -1
```

---

## 使用方法

### 可执行文件使用

#### 基本语法

```batch
ui_inference.exe [选项]
```

#### 完整命令示例

```batch
ui_inference.exe ^
  --image "C:\path\to\image.png" ^
  --config "configs\seg\sfnet_res101_ui.conf" ^
  --checkpoint "C:\path\to\checkpoint.pth" ^
  --output "C:\path\to\output" ^
  --gpu -1
```

**注意：** 在Windows命令行中，使用 `^` 进行换行。在PowerShell中，使用 `` ` `` 进行换行。

### 源代码使用

如果您从源代码运行：

```bash
python ui_inference_main.py \
  --image "path/to/image.png" \
  --config "configs/seg/sfnet_res101_ui.conf" \
  --checkpoint "path/to/checkpoint.pth" \
  --output "output_dir" \
  --gpu -1
```

---

## 参数说明

### 必需参数

| 参数 | 说明 | 示例 |
|------|------|------|
| `--image` | 输入的UI图片路径（PNG格式） | `--image "testimage\ui.png"` |
| `--config` | 模型配置文件路径 | `--config "configs\seg\sfnet_res101_ui.conf"` |
| `--checkpoint` | 模型权重文件路径（.pth文件） | `--checkpoint "checkpoints\seg\ui\sfnet_res101_ui_latest.pth"` |
| `--output` | 输出目录路径 | `--output "output_dir"` |

### 可选参数

| 参数 | 说明 | 默认值 | 示例 |
|------|------|--------|------|
| `--gpu` | 使用的GPU ID（-1表示使用CPU） | `0` | `--gpu -1` |
| `--class-names` | 类别名称列表（不包括背景） | 从配置文件读取 | `--class-names "button,text,image"` |

### 参数详细说明

#### `--image`
- **类型：** 字符串（文件路径）
- **说明：** 要处理的UI图片路径
- **支持格式：** PNG, JPG, JPEG
- **注意事项：**
  - 支持绝对路径和相对路径
  - 支持中文路径
  - 如果路径包含空格，请用引号括起来

#### `--config`
- **类型：** 字符串（文件路径）
- **说明：** 模型配置文件路径
- **默认位置：** `configs/seg/sfnet_res101_ui.conf`
- **注意事项：**
  - 配置文件已打包到可执行文件中
  - 可以使用相对路径 `configs\seg\sfnet_res101_ui.conf`
  - 也可以使用绝对路径

#### `--checkpoint`
- **类型：** 字符串（文件路径）
- **说明：** 训练好的模型权重文件路径
- **文件格式：** `.pth`（PyTorch模型文件）
- **注意事项：**
  - 必须提供有效的模型权重文件
  - 支持绝对路径和相对路径
  - 如果文件不存在，程序会报错

#### `--output`
- **类型：** 字符串（目录路径）
- **说明：** 输出文件的目录
- **注意事项：**
  - 如果目录不存在，会自动创建
  - 输出文件包括：
    - `output.html` - 生成的HTML代码
    - `prediction_mask.png` - 分割结果可视化
    - 原始图片的副本

#### `--gpu`
- **类型：** 整数
- **说明：** 指定使用的GPU设备ID
- **取值：**
  - `-1` - 使用CPU（推荐，适用于没有GPU的电脑）
  - `0, 1, 2, ...` - 使用指定ID的GPU
- **注意事项：**
  - 如果指定了GPU但系统没有GPU，程序会报错
  - CPU推理速度较慢，但可以在任何电脑上运行

#### `--class-names`
- **类型：** 字符串（逗号分隔的类别名称列表）
- **说明：** UI组件的类别名称
- **示例：** `--class-names "button,text,image,list,icon"`
- **注意事项：**
  - 类别名称不包括背景类
  - 如果不指定，将从配置文件读取
  - 类别数量必须与模型输出的类别数匹配

---

## 使用示例

### 示例1：使用测试脚本（最简单）

```batch
# 在项目根目录运行
.\scripts\test_exe.bat
```

这将自动：
- 查找 `testimage` 目录下的PNG图片
- 使用默认配置和检查点
- 输出到 `dist\ui_inference_dist\test_output`

### 示例2：处理单张图片（CPU模式）

```batch
cd dist\ui_inference_dist
ui_inference.exe --image "..\..\testimage\ui.png" --config "configs\seg\sfnet_res101_ui.conf" --checkpoint "..\..\checkpoints\seg\ui\sfnet_res101_ui_latest.pth" --output "my_output" --gpu -1
```

### 示例3：处理单张图片（GPU模式）

```batch
cd dist\ui_inference_dist
ui_inference.exe --image "C:\Users\YourName\Desktop\ui.png" --config "configs\seg\sfnet_res101_ui.conf" --checkpoint "C:\Users\YourName\Desktop\checkpoint.pth" --output "C:\Users\YourName\Desktop\output" --gpu 0
```

### 示例4：指定类别名称

```batch
cd dist\ui_inference_dist
ui_inference.exe --image "ui.png" --config "configs\seg\sfnet_res101_ui.conf" --checkpoint "checkpoint.pth" --output "output" --gpu -1 --class-names "button,text,image,list,icon,header,footer"
```

### 示例5：使用绝对路径

```batch
ui_inference.exe --image "D:\MyProjects\UI\design.png" --config "D:\MyProjects\torchcv-master\configs\seg\sfnet_res101_ui.conf" --checkpoint "D:\MyProjects\torchcv-master\checkpoints\seg\ui\sfnet_res101_ui_latest.pth" --output "D:\MyProjects\UI\output" --gpu -1
```

---

## 输出说明

运行成功后，在输出目录中会生成以下文件：

### 1. `output.html`
- **说明：** 生成的HTML代码文件
- **内容：** 包含完整的HTML和CSS代码，可以直接在浏览器中打开查看
- **用途：** 
  - 可以直接复制到网页项目中使用
  - 可以用于查看UI组件的布局和样式

### 2. `prediction_mask.png`
- **说明：** 分割结果的可视化图像
- **内容：** 不同颜色代表不同的UI组件类别
- **用途：**
  - 用于验证分割结果
  - 用于调试和优化模型

### 3. 原始图片副本
- **说明：** 输入图片的副本
- **文件名：** 与输入图片同名
- **用途：** 方便对比原始图片和分割结果

### 输出目录结构示例

```
output_dir/
├── output.html                    # HTML代码文件
├── prediction_mask.png            # 分割结果可视化
└── ui.png                         # 原始图片副本
```

---

## 常见问题

### Q1: 可执行文件无法运行，提示"缺少DLL"或"无法加载Python DLL"

**A:** 这可能是由于：
1. 可执行文件不完整 - 请重新运行打包脚本 `.\scripts\build_exe_clean.ps1`
2. 杀毒软件拦截 - 请将可执行文件添加到杀毒软件的白名单
3. 系统缺少必要的运行库 - 请安装 Visual C++ Redistributable

**解决方法：**
- 重新打包可执行文件
- 检查杀毒软件设置
- 安装 [Visual C++ Redistributable](https://aka.ms/vs/17/release/vc_redist.x64.exe)

### Q2: 提示"Config file not found"

**A:** 配置文件路径不正确。

**解决方法：**
- 确保配置文件路径正确
- 使用相对路径时，确保从正确的目录运行
- 配置文件已打包到可执行文件中，可以使用相对路径 `configs\seg\sfnet_res101_ui.conf`

### Q3: 提示"Checkpoint file not found"

**A:** 模型权重文件路径不正确或文件不存在。

**解决方法：**
- 检查检查点文件路径是否正确
- 确保文件存在且是有效的 `.pth` 文件
- 使用绝对路径可以避免路径问题

### Q4: 提示"Image file not found"或"can't open/read file"

**A:** 图片文件路径不正确或文件损坏。

**解决方法：**
- 检查图片文件路径是否正确
- 确保图片文件存在且未损坏
- 支持中文路径，但如果路径包含特殊字符，请使用引号括起来
- 确保图片格式为PNG、JPG或JPEG

### Q5: 运行速度很慢

**A:** 这是正常的，特别是使用CPU模式时。

**解决方法：**
- 使用GPU模式可以显著提高速度（需要NVIDIA GPU和CUDA）
- CPU模式速度较慢，但可以在任何电脑上运行
- 处理大图片时速度会更慢，这是正常现象

### Q6: 生成的HTML代码不准确

**A:** 这可能是因为：
1. 模型没有充分训练
2. 输入图片与训练数据差异较大
3. 图片质量较低

**解决方法：**
- 使用训练更好的模型权重
- 确保输入图片质量良好
- 调整模型参数或重新训练模型

### Q7: 可执行文件很大（几百MB）

**A:** 这是正常的，因为单文件模式将所有依赖都打包进去了。

**说明：**
- 可执行文件包含Python解释器、PyTorch、OpenCV等所有依赖
- 这是为了在没有Python环境的电脑上也能运行
- 如果需要减小文件大小，可以使用多文件模式，但这需要同时分发多个文件

### Q8: 支持哪些图片格式？

**A:** 目前支持以下格式：
- PNG（推荐）
- JPG/JPEG
- BMP

**建议：** 使用PNG格式，因为它支持透明背景，更适合UI设计图。

---

## 故障排除

### 问题1：可执行文件闪退

**症状：** 双击可执行文件后，窗口立即关闭。

**解决方法：**
1. 使用命令行运行，查看错误信息：
   ```batch
   cd dist\ui_inference_dist
   ui_inference.exe --image "test.png" --config "configs\seg\sfnet_res101_ui.conf" --checkpoint "checkpoint.pth" --output "output" --gpu -1
   ```
2. 检查错误信息，根据错误信息进行修复
3. 确保所有必需的文件都存在

### 问题2：内存不足

**症状：** 程序运行时提示内存不足或崩溃。

**解决方法：**
1. 关闭其他占用内存的程序
2. 使用较小的图片
3. 如果使用GPU，确保GPU内存足够
4. 增加系统虚拟内存

### 问题3：路径包含中文时出错

**症状：** 当路径包含中文字符时，程序无法读取文件。

**解决方法：**
- 程序已经支持中文路径
- 如果仍有问题，请确保：
  - 使用UTF-8编码保存文件
  - 路径使用引号括起来
  - 避免使用特殊字符

### 问题4：GPU无法使用

**症状：** 指定GPU后，程序仍然使用CPU或报错。

**解决方法：**
1. 检查系统是否有NVIDIA GPU
2. 检查是否安装了CUDA和cuDNN
3. 检查GPU驱动是否最新
4. 使用 `--gpu -1` 强制使用CPU

### 问题5：输出文件为空或不完整

**症状：** 运行成功，但输出文件为空或缺少某些文件。

**解决方法：**
1. 检查输出目录的写入权限
2. 确保磁盘空间充足
3. 检查程序日志，查看是否有错误信息
4. 重新运行程序

---

## 技术支持

如果您遇到其他问题，请：

1. **查看日志：** 程序运行时会输出详细的日志信息，请查看错误信息
2. **检查文件：** 确保所有必需的文件都存在且路径正确
3. **重新打包：** 如果是可执行文件的问题，请重新运行打包脚本
4. **使用源代码：** 如果可执行文件有问题，可以尝试使用源代码运行

---

## 更新日志

### 版本 1.0.0 (2025-11-11)
- 初始版本发布
- 支持单文件可执行文件
- 支持CPU和GPU推理
- 支持中文路径
- 自动处理图片读取失败的情况

---

## 许可证

请参考项目根目录下的 `LICENSE` 文件。

---

## 致谢

感谢所有为这个项目做出贡献的开发者和研究人员。

---

**最后更新：** 2025-11-11

