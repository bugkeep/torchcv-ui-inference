## 从零开始的开发文档（Windows 10/11）

本项目为一个通用计算机视觉训练/推理框架，已扩展支持“UI界面语义分割并自动生成HTML”。如果你从零开始，请按本文档逐步完成：环境准备、项目运行、数据准备、训练、推理与部署、以及常见问题解答。

### 适用读者
- 完全零基础或刚接触 PyTorch/深度学习的同学
- 想直接使用现成模型跑通推理，并逐步过渡到训练与自定义开发

---

## 1. 环境准备与安装

### 1.1 系统与依赖
- **操作系统**: Windows 10/11（管理员权限）
- **Python**: 建议 3.8 ~ 3.10（与 `requirements.txt` 兼容）
- **GPU/驱动（可选）**: NVIDIA 显卡 + 正确版本的 CUDA/cuDNN（若仅 CPU 运行可忽略）

### 1.2 安装步骤（推荐虚拟环境）

1) 安装 Python 或 Anaconda（任选其一）
- 方式A：从 `python.org` 安装 Python（勾选 “Add Python to PATH”）
- 方式B：安装 Anaconda/Miniconda（便于管理环境）

2) 创建虚拟环境（任选其一）
- 原生 venv：
```bash
python -m venv torchcv_env
.\torchcv_env\Scripts\activate
```
- Conda：
```bash
conda create -n torchcv_env python=3.10 -y
conda activate torchcv_env
```

3) 安装依赖
```bash
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

4) 可选：安装匹配的 PyTorch GPU 版本
- 到 PyTorch 官网上选择与你显卡驱动/CUDA 匹配的命令，示例（仅示例，请以官网为准）：
```bash
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu121
```

5) 验证安装
```bash
python -c "import torch;print('torch:', torch.__version__, 'cuda:', torch.cuda.is_available())"
```
出现 `cuda: True` 表示 GPU 可用，否则将以 CPU 运行。

---

## 2. 项目结构速览（重要目录）

```
torchcv-master/
├─ configs/                # 各任务配置（分类/检测/分割/姿态/生成等）
│  └─ seg/                 # 语义分割配置
│     ├─ cityscapes/*.conf
│     └─ sfnet_res101_ui.conf    # UI 分割专用配置
├─ data/                   # 数据加载器、数据集与预处理
│  ├─ seg/datasets/        # 分割数据集定义（含 UI 数据集）
│  └─ test/                # 简易测试数据加载
├─ lib/                    # 框架核心库（数据增强、并行、Runner、工具等）
├─ model/                  # 各任务模型定义与管理（含 seg 模块）
├─ runner/                 # 训练/评估 Runner（按任务分类）
├─ scripts/                # 脚本集合
│  └─ data/preprocess_ui.py# UI 标注边框 -> 分割掩码 预处理
├─ sfnvision_tools/        # UI 掩码解析与 HTML/CSS 生成工具
├─ ui_inference_main.py    # UI 单图推理 + HTML 生成入口
├─ main.py                 # 通用训练/测试入口
└─ requirements.txt        # 依赖清单
```

---

## 3. 快速上手：不用训练，先跑一次推理

你需要一个预训练的 UI 分割模型权重（`.pth`）。将其放到：`./checkpoints/seg/ui/sfnet_res101_ui_latest.pth`（或用参数指定路径）。

```bash
python ui_inference_main.py \
  --image .\testimage\test1.png \
  --config configs/seg/sfnet_res101_ui.conf \
  --checkpoint .\checkpoints\seg\ui\sfnet_res101_ui_latest.pth \
  --output .\output \
  --class_names button text image icon input list card toolbar drawer background \
  --gpu 0
```
运行完成后在 `.\output` 下可看到：
- `prediction_mask.png`：预测掩码可视化
- `output.html`：自动生成的 HTML 页面（以原图为背景，覆盖预测组件）
- 输入图片的副本

若没有 GPU 或不想用 GPU：把 `--gpu -1` 即可走 CPU。

---

## 4. 数据准备（以 UI 分割为例）

### 4.1 标注转换（可选）
如果你的 UI 标注是“边界框 JSON”，可先转为“像素级分割掩码”：
```bash
python scripts/data/preprocess_ui.py \
  --json_dir /path/to/json \
  --image_dir /path/to/images \
  --output_dir /path/to/output/masks \
  --image_ext .png \
  --json_ext .json
```

### 4.2 数据集目录结构
```
dataset/
├─ train/
│  ├─ image/   # 原图
│  └─ label/   # 掩码（PNG，像素值为类别ID；0为背景，1..K为前景类）
├─ val/
│  ├─ image/
│  └─ label/
└─ test/
   └─ image/
```

### 4.3 类别定义
- 默认包含 10 类（不含背景）：`button, text, image, icon, input, list, card, toolbar, drawer, background`
- 配置中的 `data.num_classes` 填写“前景类别数量”（不包含背景）；上面例子应为 10。

---

## 5. 训练与验证（通用入口 main.py）

`main.py` 是统一的训练/验证入口，通过配置文件和命令行参数组合控制。

### 5.1 关键概念
- `--config_file`：主配置文件（如 `configs/seg/sfnet_res101_ui.conf`）
- `--phase`：`train` 或 `test`
- `--gpu`：GPU 列表（如 `--gpu 0 1`），或设 `-1` 使用 CPU
- 数据、网络、优化器、日志等皆可用命令行覆盖配置文件中的值

### 5.2 启动训练
```bash
python main.py \
  --config_file configs/seg/sfnet_res101_ui.conf \
  --phase train \
  --gpu 0 \
  --data_dir D:\data\ui_dataset
```
常见可覆盖参数（按需选择）：
- 数据：`--train_batch_size 8 --val_batch_size 4 --workers 4`
- 网络：`--backbone deepbase_resnet101 --model_name res_sfnet --syncbn true`
- 学习率/训练：`--base_lr 0.01 --max_epoch 80 --save_epoch 1`
- 断点续训：`--resume path\to\xxx.pth --resume_continue true`

### 5.3 验证/测试
训练好的模型在配置里会保存到 `checkpoints_root/checkpoints_name` 目录。使用测试：
```bash
python main.py \
  --config_file configs/seg/sfnet_res101_ui.conf \
  --phase test \
  --gpu 0 \
  --data_dir D:\data\ui_dataset \
  --network.resume .\checkpoints\seg\ui\sfnet_res101_ui_latest.pth
```

---

## 6. UI 单图推理并生成 HTML（详细说明）

入口脚本：`ui_inference_main.py`

参数：
- `--image`：输入图片路径（必填）
- `--config`：配置文件（默认 `configs/seg/sfnet_res101_ui.conf`）
- `--checkpoint`：模型权重路径（默认 `./checkpoints/seg/ui/sfnet_res101_ui_latest.pth`）
- `--output`：输出目录（默认 `./output`）
- `--class_names`：类别名称列表（顺序需与训练一致）
- `--gpu`：GPU ID（-1 使用 CPU）

内部流程（简述）：
1) 使用 `Configer` 读取配置；
2) `ModelManager` 构建分割模型并加载权重；
3) 读取并标准化图片，前向推理生成整张图的类别掩码；
4) `sfnvision_tools.mask_parser.parse_mask_to_components` 将掩码解析为组件列表；
5) `sfnvision_tools.code_generator.generate_html_css` 生成带有背景图与定位 CSS 的 HTML。

---

## 7. 配置文件与命令行（常用字段）

以 `configs/seg/sfnet_res101_ui.conf` 为例，常见关键字段：
- **task**：`"seg"` 表示语义分割任务
- **data**：`data_dir`、`num_classes`、`normalize`、`workers` 等
- **network**：`backbone`、`model_name`（如 `res_sfnet`）、`pretrained`、`syncbn`、`resume` 等
- **solver**：`optim_method`、`lr` 策略、`max_epoch`/`max_iters`、`save_epoch` 等
- **logging**：日志等级与格式

命令行可覆盖配置，例如：`--data_dir` 对应 `data.data_dir`、`--backbone` 对应 `network.backbone`。

---

## 8. 扩展与二次开发

### 8.1 新增/替换类别
1) 更新配置中的 `data.num_classes`；
2) 准备标签掩码（像素值与类别一一对应，0 为背景）；
3) 重新训练；
4) 推理时同步更新 `--class_names` 顺序与数量。

### 8.2 自定义 HTML 样式/布局
修改 `sfnvision_tools/code_generator.py` 中样式模板与定位策略（CSS/HTML 结构），可以定制前端展示。

### 8.3 自定义数据增强/预处理
参考 `lib/data/transforms.py`、`lib/data/cv2_aug_transforms.py`、`lib/data/pil_aug_transforms.py`，在配置中挂接自定义的增强流水线。

### 8.4 模型结构修改
在 `model/seg/nets/` 下扩展或替换网络；在 `model/seg/model_manager.py` 中注册入口；在配置中切换 `network.model_name`。

---

## 9. 性能建议与资源占用

- **显存不足**：减小 `train_batch_size`、使用更小的 `input_size`、关闭 `syncbn`
- **CPU 跑得慢**：优先使用 GPU；或减小输入尺寸/裁剪尺度
- **多卡训练**：使用 `--gpu 0 1 ...` 并设置 `--dist true`（如需分布式），确保 NCCL/CUDA 环境正常
- **CUDNN**：默认已开启 `benchmark`，固定输入尺寸时可提升速度

---

## 10. 常见问题（FAQ）与排错

### 10.1 模型加载失败
- 确认 `--checkpoint` 路径存在；
- 确认配置里的 `network.model_name/backbone/num_classes` 与权重匹配；
- 若键不匹配，尝试 `--resume_strict false`。

### 10.2 推理类别不对/HTML 组件异常
- 确保训练与推理时的类别顺序完全一致；
- 检查掩码像素值是否与类别索引一致（0 背景，1..K 前景）。

### 10.3 CUDA/驱动问题
- 用 `python -c "import torch;print(torch.cuda.is_available())"` 检查；
- 重新安装与你驱动匹配的 PyTorch CUDA 版本；
- 临时用 CPU：`--gpu -1`。

### 10.4 数据找不到/路径错误
- Windows 路径建议使用双引号或反斜杠转义；
- 确认 `--data_dir` 指向的数据集根目录结构正确。

---

## 11. 参考与进阶阅读

- SFNet: Semantic Flow for Fast and Accurate Scene Parsing（原论文）
- 项目根目录 `README.md`（包含更多泛化任务信息）
- 目录 `docs/`（包含 Sphinx 构建的历史文档与资源）

---

## 12. 附录：核心脚本一览（UI 相关）

- `scripts/data/preprocess_ui.py`：UI 标注（框）转分割掩码
- `data/seg/datasets/ui_dataset.py`：UI 数据集定义
- `configs/seg/sfnet_res101_ui.conf`：UI 分割配置
- `sfnvision_tools/mask_parser.py`：掩码 -> 组件列表
- `sfnvision_tools/code_generator.py`：组件 -> HTML/CSS
- `ui_inference_main.py`：单图推理 + HTML 生成入口

祝你开发顺利！若遇到问题，请先查看“常见问题”和控制台日志，再反馈具体报错信息以便定位。
